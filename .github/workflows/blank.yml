name: SAWeather Android CI/CD

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 1' # Weekly build every Monday at 2 AM UTC
  workflow_dispatch: # Manual trigger option

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  ANDROID_API_LEVEL: 34
  ANDROID_BUILD_TOOLS: "34.0.0"

jobs:
  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Run unit tests
      run: ./gradlew testDebugUnitTest --stacktrace --no-daemon

    - name: Upload unit test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: |
          app/build/reports/tests/
          app/build/test-results/
        retention-days: 7

  build:
    name: Build APKs
    runs-on: ubuntu-latest
    needs: unit-test
    
    strategy:
      matrix:
        build-type: [debug, release]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Build ${{ matrix.build-type }} APK
      run: ./gradlew assemble${{ matrix.build-type }} --stacktrace --no-daemon

    - name: Upload ${{ matrix.build-type }} APK
      uses: actions/upload-artifact@v4
      with:
        name: saweather-${{ matrix.build-type }}-apk
        path: app/build/outputs/apk/${{ matrix.build-type }}/*.apk
        retention-days: 30

  lint-analysis:
    name: Code Quality & Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Run lint analysis
      run: ./gradlew lintDebug --stacktrace --no-daemon

    - name: Run ktlint check
      run: |
        ./gradlew ktlintCheck --stacktrace --no-daemon || echo "ktlint not configured"

    - name: Upload lint reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: lint-reports
        path: app/build/reports/lint/
        retention-days: 7

  instrumented-tests:
    name: Instrumented Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Run instrumented tests
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 33
        target: google_apis
        arch: x86_64
        profile: pixel_4
        script: ./gradlew connectedDebugAndroidTest --stacktrace --no-daemon

    - name: Upload instrumented test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: instrumented-test-results
        path: |
          app/build/reports/androidTests/
          app/build/outputs/androidTest-results/
        retention-days: 7

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Run security lint
      run: ./gradlew lintDebug -Psecurity --stacktrace --no-daemon

    - name: Check for hardcoded secrets
      run: |
        echo "Running secret detection..."
        # Check for potential API keys and secrets
        if grep -r "api_key\|password\|secret" --include="*.kt" --include="*.java" --include="*.gradle" --include="*.xml" app/src/ | grep -v "R.string\|@string"; then
          echo "Warning: Potential hardcoded secrets found"
          exit 1
        fi

    - name: Dependency vulnerability check
      run: |
        echo "Running dependency check..."
        ./gradlew dependencyCheckAnalyze --stacktrace --no-daemon || echo "OWASP dependency check not configured"

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          app/build/reports/dependency-check/
          app/build/reports/lint/
        retention-days: 7

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [unit-test, build, lint-analysis, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Build release APK
      run: ./gradlew assembleRelease --stacktrace --no-daemon

    - name: Generate build number
      id: build-number
      run: echo "number=$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.${{ steps.build-number.outputs.number }}
        release_name: Release v1.0.${{ steps.build-number.outputs.number }}
        draft: false
        prerelease: false
        files: |
          app/build/outputs/apk/release/*.apk
          app/build/reports/tests/testDebugUnitTest/*
        body: |
          ## SAWeather App Release
          
          ### Changes
          - Automated build from GitHub Actions
          - Includes unit test results
          - Security scanned
          
          ### Download
          APK files are attached below.

    - name: Upload to release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-artifacts
        path: |
          app/build/outputs/apk/release/*.apk
          app/build/reports/
        retention-days: 30

  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [unit-test, build, lint-analysis, security-scan]
    if: always()
    
    steps:
    - name: Notify workflow status
      run: |
        if [ "${{ needs.unit-test.result }}" == "success" ] && [ "${{ needs.build.result }}" == "success" ]; then
          echo "✅ All checks passed!"
        else
          echo "❌ Some checks failed. Check the workflow results."
        fi
